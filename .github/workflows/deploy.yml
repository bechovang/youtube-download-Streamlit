name: Deploy to Home Server

on:
  push:
    branches: [ "main" ]  # Cháº¡y khi cÃ³ code má»›i Ä‘áº©y lÃªn nhÃ¡nh main

jobs:
  deploy:
    runs-on: self-hosted  # Cháº¡y trÃªn mÃ¡y PC cÅ© cá»§a báº¡n
    
    steps:
    - name: 1. Láº¥y code má»›i nháº¥t tá»« GitHub
      uses: actions/checkout@v3

    - name: 2. Copy code vÃ o thÆ° má»¥c cháº¡y web
      run: |
        # Copy toÃ n bá»™ file tá»« thÆ° má»¥c táº¡m cá»§a Runner sang thÆ° má»¥c Web
        # -r: copy thÆ° má»¥c, -u: chá»‰ update file má»›i/thay Ä‘á»•i
        cp -ru * /mnt/data/youtube-web/
        
        echo "âœ… ÄÃ£ copy code má»›i sang /mnt/data/youtube-web"

    - name: 3. CÃ i Ä‘áº·t thÆ° viá»‡n & Khá»Ÿi Ä‘á»™ng láº¡i
      run: |
        cd /mnt/data/youtube-web
        
        # CÃ i Ä‘áº·t thÆ° viá»‡n má»›i (náº¿u cÃ³)
        source venv/bin/activate
        pip install -r requirements.txt
        
        # Restart á»©ng dá»¥ng (Táº¯t tmux cÅ©, báº­t tmux má»›i)
        # Náº¿u tmux 'youtube' chÆ°a cháº¡y thÃ¬ bá» qua lá»—i (|| true)
        tmux kill-session -t youtube || true
        
        # Cháº¡y session má»›i tÃªn lÃ  'youtube'
        tmux new -d -s youtube 'source venv/bin/activate && streamlit run app.py'
        
        echo "ğŸš€ ÄÃ£ khá»Ÿi Ä‘á»™ng láº¡i Web thÃ nh cÃ´ng!"